"use strict";(()=>{var e={};e.id=356,e.ids=[356],e.modules={3524:e=>{e.exports=require("@prisma/client")},4530:e=>{e.exports=require("@prisma/client/runtime/library")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1071:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var r={};n.r(r),n.d(r,{POST:()=>m});var i=n(3278),a=n(5002),s=n(4877),l=n(1309),o=n(8713),u=n(9495),c=n(3656),d=n(6176),p=n(4530);async function m(e){console.log("SERVER USER CALL!!!");let t=await e.json(),{telegramInitData:n,referrerTelegramId:r}=t;if(console.log("Request body:",t),console.log("Telegram Init Data:",n),console.log("Referrer Telegram ID:",r),!n)return l.NextResponse.json({error:"Invalid request"},{status:400});let{validatedData:i,user:a}=(0,c.M)(n);if(console.log("Validated data",i),console.log("User",a),!i)return l.NextResponse.json({error:"Invalid Telegram data"},{status:403});console.log("User: ",a);let s=a.id?.toString();if(!s)return l.NextResponse.json({error:"Invalid user data"},{status:400});try{let e=await o.Z.$transaction(async e=>{let t=await e.user.findUnique({where:{telegramId:s},include:{referredBy:!0}}),n=new Date;if(t){let r=0;for(;r<3;)try{if(!t)throw Error("User data unexpectedly null");let r=(0,d.Ms)(t.mineLevelIndex,t.lastPointsUpdateTimestamp.getTime(),n.getTime()),i=t.points+r,l=(0,d.rV)(i),o=(0,d.rV)(t.points),c=t.energy,p=(0,d.gC)(t.multitapLevelIndex,t.lastEnergyUpdateTimestamp.getTime(),n.getTime()),m=(0,d.Ol)(t.energyLimitLevelIndex),f=new Date(t.lastEnergyRefillsTimestamp),g=n.getUTCDate()!==f.getUTCDate()||n.getUTCMonth()!==f.getUTCMonth()||n.getUTCFullYear()!==f.getUTCFullYear(),y=a?.is_premium||!1,v=0;if(l>o)for(let e=o+1;e<=l;e++)v+=y?u.zq[e].friendBonusPremium:u.zq[e].friendBonus;t=await e.user.update({where:{telegramId:s,lastPointsUpdateTimestamp:t.lastPointsUpdateTimestamp},data:{name:a?.first_name||"",isPremium:y,points:i,pointsBalance:{increment:r},offlinePointsEarned:r,referralPointsEarned:{increment:v},lastPointsUpdateTimestamp:n,energy:Math.min(c+p,m),energyRefillsLeft:g?u.AG:t.energyRefillsLeft,lastEnergyUpdateTimestamp:n,lastEnergyRefillsTimestamp:g?n:t.lastEnergyRefillsTimestamp},include:{referredBy:!0}}),v>0&&t.referredBy&&await e.user.update({where:{id:t.referredBy.id},data:{points:{increment:v},pointsBalance:{increment:v}}});break}catch(n){if(n instanceof p.PrismaClientKnownRequestError&&"P2034"===n.code){if(++r>=3)throw Error("Max retries reached for optimistic locking");await new Promise(e=>setTimeout(e,100*Math.pow(2,r))),t=await e.user.findUnique({where:{telegramId:s},include:{referredBy:!0}})}else throw n}}else{let i=null;r&&(i=await e.user.findUnique({where:{telegramId:r}}));let l=a?.is_premium||!1,o=i?l?u.cu:u.du:0,c=(0,d.rV)(o),p=o;if(i)for(let e=1;e<=c;e++)p+=l?u.zq[e].friendBonusPremium:u.zq[e].friendBonus;t=await e.user.create({data:{telegramId:s,name:a?.first_name||"",isPremium:l,points:o,pointsBalance:o,offlinePointsEarned:0,referralPointsEarned:p,multitapLevelIndex:0,energy:u.Fq,energyRefillsLeft:u.AG,energyLimitLevelIndex:0,mineLevelIndex:0,lastPointsUpdateTimestamp:n,lastEnergyUpdateTimestamp:n,lastEnergyRefillsTimestamp:n,referredBy:i?{connect:{id:i.id}}:void 0},include:{referredBy:!0}}),i&&await e.user.update({where:{id:i.id},data:{points:{increment:p},pointsBalance:{increment:p},referrals:{connect:{id:t.id}}}})}return t});return l.NextResponse.json(e)}catch(e){if(e instanceof p.PrismaClientKnownRequestError&&"P2002"===e.code)return console.log("User already exists:",e),l.NextResponse.json({error:"User already exists"},{status:409});return console.error("Error fetching/creating user:",e),l.NextResponse.json({error:"Failed to fetch/create user"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/user/route",pathname:"/api/user",filename:"route",bundlePath:"app/api/user/route"},resolvedPagePath:"D:\\Projects\\GMSTree\\Gmstree-master for dev\\Gmstree-master\\app\\api\\user\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:v}=f,x="/api/user/route";function h(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},8761:(e,t,n)=>{var r=n(6269),i="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},a=r.useState,s=r.useEffect,l=r.useLayoutEffect,o=r.useDebugValue;function u(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!i(e,n)}catch(e){return!0}}var c="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var n=t(),r=a({inst:{value:n,getSnapshot:t}}),i=r[0].inst,c=r[1];return l(function(){i.value=n,i.getSnapshot=t,u(i)&&c({inst:i})},[e,n,t]),s(function(){return u(i)&&c({inst:i}),e(function(){u(i)&&c({inst:i})})},[e]),o(n),n};t.useSyncExternalStore=void 0!==r.useSyncExternalStore?r.useSyncExternalStore:c},7143:(e,t,n)=>{var r=n(6269),i=n(8230),a="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=i.useSyncExternalStore,l=r.useRef,o=r.useEffect,u=r.useMemo,c=r.useDebugValue;t.useSyncExternalStoreWithSelector=function(e,t,n,r,i){var d=l(null);if(null===d.current){var p={hasValue:!1,value:null};d.current=p}else p=d.current;var m=s(e,(d=u(function(){function e(e){if(!o){if(o=!0,s=e,e=r(e),void 0!==i&&p.hasValue){var t=p.value;if(i(t,e))return l=t}return l=e}if(t=l,a(s,e))return t;var n=r(e);return void 0!==i&&i(t,n)?t:(s=e,l=n)}var s,l,o=!1,u=void 0===n?null:n;return[function(){return e(t())},null===u?void 0:function(){return e(u())}]},[t,n,r,i]))[0],d[1]);return o(function(){p.hasValue=!0,p.value=m},[m]),c(m),m}},8230:(e,t,n)=>{e.exports=n(8761)},5745:(e,t,n)=>{e.exports=n(7143)},6176:(e,t,n)=>{let r,i;n.d(t,{Ol:()=>E,gw:()=>h,rV:()=>y,bj:()=>P,Ms:()=>L,hP:()=>v,Fc:()=>x,Ck:()=>w,gC:()=>T});let a=e=>{let t;let n=new Set,r=(e,r)=>{let i="function"==typeof e?e(t):e;if(!Object.is(i,t)){let e=t;t=(null!=r?r:"object"!=typeof i||null===i)?i:Object.assign({},t,i),n.forEach(n=>n(t,e))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>s,subscribe:e=>(n.add(e),()=>n.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},s=t=e(r,i,a);return a},s=e=>e?a(e):a;var l=n(6269),o=n(5745);let{useDebugValue:u}=l,{useSyncExternalStoreWithSelector:c}=o,d=!1,p=e=>e,m=(e,t,n)=>Math.floor(t*Math.pow(n,e)),f=(e,t,n)=>{let r=0;for(let i=0;i<=e;i++)r+=Math.floor(t*Math.pow(n,i));return r};var g=n(9495);let y=e=>{for(let t=g.zq.length-1;t>=0;t--)if(e>=g.zq[t].minPoints)return t;return 0},v=e=>m(e,g.xj,g.QA),x=e=>f(e,g.J0,g.FJ),h=e=>m(e,g.pT,g.BI),E=e=>f(e,g.Fq,g.sx),P=e=>m(e,g.wA,g.nS),w=e=>Math.max(0,f(e,g.lT,g.dx)-g.lT),L=(e,t,n)=>{if(t>=n)return 0;let r=n-t;return r>g.wX&&(r=g.wX),Math.max(0,w(e)/36e5*r)},T=(e,t,n)=>Math.max(0,x(e)*Math.floor((n-t)/1e3));r={userTelegramInitData:"",userTelegramName:"",lastClickTimestamp:0,gameLevelIndex:0,points:1e4,pointsBalance:1e4,unsynchronizedPoints:0,multitapLevelIndex:0,pointsPerClick:1,energy:g.Fq,maxEnergy:g.Fq,energyRefillsLeft:1,energyLimitLevelIndex:0,lastEnergyRefillTimestamp:Date.now(),mineLevelIndex:0,profitPerHour:0,tonWalletAddress:null},(i=e=>({...r,initializeState:t=>e(e=>({...e,...t})),updateLastClickTimestamp:()=>e(e=>({lastClickTimestamp:Date.now()})),setPoints:t=>e(e=>{let n=y(t);return{points:t,gameLevelIndex:n}}),clickTriggered:()=>e(e=>{if(e.energy-e.pointsPerClick<0)return{};let t=e.points+e.pointsPerClick,n=e.pointsBalance+e.pointsPerClick,r=e.unsynchronizedPoints+e.pointsPerClick,i=e.energy-e.pointsPerClick,a=y(t);return{points:t,pointsBalance:n,unsynchronizedPoints:r,energy:i,gameLevelIndex:a,lastClickTimestamp:Date.now()}}),setPointsBalance:t=>e(e=>({pointsBalance:t})),incrementPoints:t=>e(e=>{let n=e.points+t,r=e.pointsBalance+t,i=y(n);return{points:n,pointsBalance:r,gameLevelIndex:i}}),decrementPointsBalance:t=>e(e=>({pointsBalance:Math.max(0,e.pointsBalance-t)})),resetUnsynchronizedPoints:t=>e(e=>({unsynchronizedPoints:Math.max(0,e.unsynchronizedPoints-t)})),setPointsPerClick:t=>e({pointsPerClick:t}),upgradeMultitap:()=>e(e=>{let t=v(e.multitapLevelIndex);return e.pointsBalance>=t?{pointsBalance:e.pointsBalance-t,pointsPerClick:x(e.multitapLevelIndex+1),multitapLevelIndex:e.multitapLevelIndex+1}:e}),setEnergy:t=>e({energy:t}),incrementEnergy:t=>e(e=>({energy:Math.min(e.energy+t,e.maxEnergy)})),refillEnergy:()=>e(e=>e.energyRefillsLeft>0?{energy:e.maxEnergy,energyRefillsLeft:e.energyRefillsLeft-1,lastEnergyRefillTimestamp:Date.now()}:e),upgradeEnergyLimit:()=>e(e=>{let t=h(e.energyLimitLevelIndex);return e.pointsBalance>=t?{pointsBalance:e.pointsBalance-t,maxEnergy:E(e.energyLimitLevelIndex+1),energyLimitLevelIndex:e.energyLimitLevelIndex+1}:e}),resetDailyRefills:()=>e({energyRefillsLeft:1}),setMineLevelIndex:t=>e({mineLevelIndex:t}),upgradeMineLevelIndex:()=>e(e=>{let t=P(e.mineLevelIndex);return e.pointsBalance>=t?{pointsBalance:e.pointsBalance-t,profitPerHour:w(e.mineLevelIndex+1),mineLevelIndex:e.mineLevelIndex+1}:e}),setTonWalletAddress:t=>e({tonWalletAddress:t})}))&&(e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");let t="function"==typeof e?s(e):e,n=(e,n)=>(function(e,t=p,n){n&&!d&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),d=!0);let r=c(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return u(r),r})(t,e,n);return Object.assign(n,t)})(i)}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[379,833,563],()=>n(1071));module.exports=r})();